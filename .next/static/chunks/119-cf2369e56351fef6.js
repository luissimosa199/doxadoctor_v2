"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[119],{8119:function(e,t,r){r.r(t),r.d(t,{ContextProvider:function(){return d},SocketContext:function(){return c}});var a=r(5893),o=r(7294),n=r(3920),i=r(3299);async function l(e){let{room:t,newMessage:r}=e;try{var a;let e=await fetch("/api/chat/".concat(t),{method:"POST",body:JSON.stringify({timestamp:null===(a=r.timestamp)||void 0===a?void 0:a.toISOString(),user:r.user,message:r.message,files:r.files})});if(e.ok)return;{let t=await e.json();console.error("Error saving message:",t)}}catch(e){console.error("Error sending POST request:",e.message)}}var s=r(1367),u=r(9403);let c=(0,o.createContext)(void 0),d=e=>{let{duration:t,chatBoxVariant:r,children:d}=e,[m,f]=(0,o.useState)(null);if(!m){console.log("route not found");let e=(0,n.io)();f(e)}let{data:g,status:p}=(0,i.useSession)(),[h,v]=(0,o.useState)(""),[w,S]=(0,o.useState)([]),[E,y]=(0,o.useState)([]),[x,T]=(0,o.useState)(""),[P,D]=(0,o.useState)(null),[F,R]=(0,o.useState)(!1),[k,C]=(0,o.useState)([]),[b,I]=(0,o.useState)([]),[M,O]=(0,o.useState)(!1),J=async e=>{let{pageParam:t}=e,r=t||"";if(!P)return;let a=await fetch("/api/chat/".concat(P,"?beforeTimestamp=").concat(r),{method:"GET"});return a.json()},{fetchNextPage:N,hasNextPage:U}=(0,u.N)(["chatMessages",P],J,{getNextPageParam:e=>!!e&&!!e.oldestTimestamp&&new Date(e.oldestTimestamp).getTime().toString(),onSuccess(e){let t=e.pages.filter(e=>e&&Array.isArray(e.messages)).flatMap(e=>e.messages);y(e=>{let r=new Set(e.filter(e=>void 0!==e.timestamp).map(e=>"number"==typeof e.timestamp?e.timestamp:new Date(e.timestamp).getTime())),a=t.map(e=>({...e,timestamp:new Date(e.timestamp).getTime()})).filter(e=>!r.has(e.timestamp));return[...a,...e]})},staleTime:36e5,refetchInterval:!1});(0,o.useEffect)(()=>{if(m&&(m.on("usersInRoom",e=>{S(e)}),m.on("roomMessages",e=>{y(t=>{let r=new Set(t.map(e=>e.timestamp)),a=e.filter(e=>!r.has(e.timestamp));return[...t,...a]})}),P&&"loading"!==p)){var e;let t=(null==g?void 0:null===(e=g.user)||void 0===e?void 0:e.name)||"Invitado";m.emit("joinRoomOnConnect",P,t,()=>{console.log("Joined the room: ".concat(P))});let r={timestamp:new Date,room:P,message:"".concat(t," se ha conectado al chat"),user:"ChatBot"};m.emit("sendMessage",r),l({room:P,newMessage:r}),R(!0)}return()=>{m&&(m.off("usersInRoom"),m.off("roomMessages"),R(!1))}},[P,p]),(0,o.useEffect)(()=>{if(g&&g.user){var e;v(null==g?void 0:null===(e=g.user)||void 0===e?void 0:e.name)}else v("Invitado")},[g]),(0,o.useEffect)(()=>{k.length>0&&_()},[k]);let _=(0,o.useCallback)(()=>{var e;let t={timestamp:new Date,room:P,user:h,message:x,files:k.map(e=>({url:e,type:e.slice(-3)}))};m&&((null===(e=t.message)||void 0===e?void 0:e.trim())!==""||t.files&&t.files.length>0)&&(m.emit("sendMessage",t),P&&(console.log("@VideoCallContext",E[-1]),l({room:P,newMessage:t})),T(""),C([]),I([]))},[h,k,x,m,P]),j=async e=>{O(!0);let t=await (0,s.w8)(e);I(e=>[...e,...t]);try{let t=await (0,s.eg)(e);C(e=>[...e,...t])}catch(e){console.error("Error uploading images:",e)}O(!1),e.target.value=""};return(0,a.jsx)(c.Provider,{value:{name:h,setName:v,usersInRoom:w,fetchNextPage:N,hasNextPage:U,messages:E,status:p,sendMessage:_,message:x,setMessage:T,setRoomName:D,roomName:P,chatLoaded:F,duration:t,handleUploadImages:j,files:k,previews:b,submitBtnDisabled:M,chatBoxVariant:r},children:d})}},1367:function(e,t,r){r.d(t,{X4:function(){return p},J8:function(){return g},re:function(){return m},J4:function(){return f},tr:function(){return u},BI:function(){return c},Ef:function(){return s},Od:function(){return i},w8:function(){return l},$S:function(){return d},eg:function(){return n}});var a=r(6455),o=r.n(a);let n=async e=>{if(e.target.files){let t=Array.from(e.target.files);return await Promise.all(t.map(async e=>{let t=e,r=/\/png$/.test(t.type);if(r){var a;let e=await (a=t,new Promise((e,t)=>{let r=new Image;r.onload=function(){let a=document.createElement("canvas"),o=a.getContext("2d");if(a.width=r.width,a.height=r.height,!o)throw"canvas.getContext(2d) is false";o.drawImage(r,0,0),a.toBlob(r=>{if(r){let a=new FileReader;a.onloadend=function(){a.result?e(a.result):t(Error("Failed to convert image to JPEG"))},a.onerror=function(){t(Error("Failed to convert image to JPEG"))},a.readAsDataURL(r)}else t(Error("Failed to convert image to JPEG"))},"image/jpeg",.9)},r.onerror=function(){t(Error("Failed to load image"))},r.src=URL.createObjectURL(a)}));t=e}let o=new FormData;o.append("file",t),o.append("upload_preset","qxkzlm62");let n=await fetch("https://api.cloudinary.com/v1_1/".concat("dahu3rii0","/upload"),{method:"POST",body:o});if(n.ok){let e=await n.json();return e.secure_url}throw Error("Upload failed")}))}},i=e=>new Promise((t,r)=>{let a=e.target.files,o=[];if(a&&a.length>0){let e=0;for(let n=0;n<a.length;n++){let i=new FileReader;i.onloadend=()=>{let r=i.result;o.push(r),++e===a.length&&t(o)},i.onerror=()=>{r(Error("Failed to read file"))},i.readAsDataURL(a[n])}}else t([])}),l=e=>new Promise((t,r)=>{let a=e.target.files,o=[];if(a&&a.length>0){let e=0;for(let n=0;n<a.length;n++){let i=new FileReader;i.onloadend=()=>{let r=i.result;o.push(r),++e===a.length&&t(o)},i.onerror=()=>{r(Error("Failed to read file"))},i.readAsDataURL(a[n])}}else t([])}),s=(e,t)=>new Promise((r,a)=>{let o=e.target.files;if(o&&o.length>0){let e=[],n=0;for(let i=0;i<o.length;i++){let l=new FileReader;l.onloadend=()=>{let a=l.result;e.push(a),++n===o.length&&(t(t=>[...t,...e]),r())},l.onerror=()=>{a(Error("Failed to read file"))},l.readAsDataURL(o[i])}}else t([]),r()}),u=(e,t,r,a)=>{let o=r.map((r,a)=>(a===t&&(r.value=e.target.value),r)),n=r.some(e=>e.idx===t);n||o.push({idx:t,value:e.target.value}),a(o)},c=(e,t,r,a)=>{e.preventDefault(),r(e=>e.filter((e,r)=>r!==t)),a(e=>e.filter((e,r)=>r!==t))},d=async e=>{try{let t=await fetch("/api/timeline",{method:"POST",body:JSON.stringify(e)});return t.ok||o().fire({title:"Error",text:"Error ".concat(t.statusText),icon:"error"}),t}catch(e){throw o().fire({title:"Error",text:"Error ".concat(e),icon:"error"}),e}},m=async e=>{try{let t=await fetch("/api/timeline/".concat(e._id),{method:"PUT",body:JSON.stringify(e)});return t.ok||o().fire({title:"Error",text:"Error ".concat(t.statusText),icon:"error"}),t}catch(e){throw o().fire({title:"Error",text:"Error ".concat(e),icon:"error"}),e}},f=()=>{let e=new Date,t=e.getFullYear().toString().padStart(4,"0"),r=(e.getMonth()+1).toString().padStart(2,"0"),a=e.getDate().toString().padStart(2,"0"),o=e.getHours().toString().padStart(2,"0"),n=e.getMinutes().toString().padStart(2,"0"),i=e.getSeconds().toString().padStart(2,"0"),l=e.getMilliseconds().toString().padStart(3,"0");return"".concat(t,"-").concat(r,"-").concat(a,"T").concat(o,":").concat(n,":").concat(i,".").concat(l,"Z")},g=(e,t)=>e.map((e,r)=>{var a;let o=null===(a=t.find(e=>e.idx===r))||void 0===a?void 0:a.value;return{url:e,idx:r,caption:o}}),p=(e,t,r,a,o)=>{var n,i,l,s;return{mainText:e.mainText||"",photo:t,length:t.length,tags:r,authorId:null!==(l=null==a?void 0:null===(n=a.user)||void 0===n?void 0:n.email)&&void 0!==l?l:"defaultId",authorName:null!==(s=null==a?void 0:null===(i=a.user)||void 0===i?void 0:i.name)&&void 0!==s?s:"defaultName",links:o}}}}]);